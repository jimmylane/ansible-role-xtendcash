---
- name: install dependencies
  apt:
    name: "{{ xtendcash_dependencies }}"
    state: present
  
- name: create installation directory
  file:
    path: "{{ xtendcash_install_dir }}"
    owner: root
    group: root
    mode: 0775
    state: directory

- name: create source dir
  file:
    path: "{{ xtendcash_install_dir }}/src"
    owner: root
    group: root
    mode: 0775
    state: directory

- name: create xtendcash data dirs
  file:
    path: "{{ item }}"
    owner: "{{ xtendcash_user }}"
    group: "{{ xtendcash_group }}"
    mode: 0750
    state: directory
  with_items:
    - /var/lib/xtendcashd
    - /var/log/xtendcashd
    - /run/xtendcashd

- name: persist /run/xtendcashd
  template:
    src: tmpfiles.d.j2
    dest: /etc/tmpfiles.d/xtendcashd.conf
    owner: root
    group: root
    mode: 0644

- name: download xtendcash source code
  git:
    repo: "{{ xtendcash_source_code }}"
    version: "{{ xtendcash_source_tag }}"
    dest: "{{ xtendcash_install_dir }}/src/{{ xtendcash_source_tag }}"
    separate_git_dir: "{{ xtendcash_install_dir }}/src/.git-{{ xtendcash_source_tag }}"
    update: no
  register: xtendcash_code

- name: make xtendcash
  make:
    chdir: "{{ xtendcash_install_dir }}/src/{{ xtendcash_source_tag }}"
    target: release
  environment:
    CC: "{{ xtendcash_cc | default('gcc') }}"
    CXX: "{{ xtendcash_cxx | default('g++') }}"
    CFLAGS: "{{ xtendcash_cflags | default('-mtune=generic') }}"
    CXXFLAGS: "{{ xtendcash_cxxflags | default('-mtune=generic') }}"
  when: xtendcash_code.changed

- name: install xtendcashd service
  template:
    src:  xtendcashd.service.j2
    dest: /etc/systemd/system/xtendcashd.service
    owner: root
    group: root
    mode: 0644
  notify:
    - reload systemd
    - restart xtendcashd

- name: symlink binary directory
  file:
    src: "{{ xtendcash_install_dir }}/src/{{ xtendcash_source_tag }}/build/release/bin"
    path: "{{ xtendcash_install_dir }}/bin"
    state: link
  notify: restart xtendcashd

- name: install xtendcashd configuration
  template:
    src: xtendcashd.conf.j2
    dest: "/etc/xtendcashd.conf"
    owner: root
    group: root
    mode: 0644
  notify: restart xtendcashd

- name: ensure xtendcashd is enabled
  service:
    name: xtendcashd
    enabled: yes

- name: add xtendcash bin dir to PATH
  template:
    src: xtendcash.path.j2
    dest: /etc/profile.d/xtendcash-bin-path.sh
    owner: root
    group: root
    mode: 0664

- name: configure logrotate for xtendcash
  template:
    src: logrotate.j2
    dest: /etc/logrotate.d/xtendcash
    owner: root
    group: root
    mode: 0644
